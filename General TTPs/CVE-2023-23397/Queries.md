# Splunk
## TTP hunt - Includes domains and IPs
```
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process IN ("*rundll32.exe*davclnt.dll\,DavSetCookie*") by Processes.user, Processes.process_name, Processes.process, Processes.parent_process, Processes.parent_process_name Processes.parent_process_id Processes.dest
| `drop_dm_object_name(Processes)`
| rex field=process ".*https?:\/\/(?<http_url>[^\s]+).*"
| regex process != "(.*(10\..*|192\.168\..*|127\..*|172\.1[6-9]\..*|172\.2[0-9]\..*|172\.3[0-1]\..*).*)"
| where isnotnull(http_url)
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table dest, user, firstTime, lastTime, parent_process_name, parent_process, process_name, process, http_url
```

## TTP hunt - Only include IPs
```
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process IN ("*rundll32.exe*davclnt.dll\,DavSetCookie*") by Processes.user, Processes.process_name, Processes.process, Processes.parent_process, Processes.parent_process_name Processes.parent_process_id Processes.dest
| `drop_dm_object_name(Processes)`
| regex process = ":\/\/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}"
| regex process != "(.*(10\..*|192\.168\..*|127\..*|172\.1[6-9]\..*|172\.2[0-9]\..*|172\.3[0-1]\..*).*)"
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| table dest, user, firstTime, lastTime, parent_process_name, parent_process, parent_process_id, process_name, process
```

# MS Defender
## TTP hunt - Includes domains and IPs
```
DeviceProcessEvents 
| where Timestamp > ago(30d) 
| where InitiatingProcessFileName=~ "svchost.exe"
| where FileName == "rundll32.exe" and ProcessCommandLine contains "davclnt.dll" and ProcessCommandLine contains "DavSetCookie"
| where ProcessCommandLine !contains "http://10."
| where ProcessCommandLine !contains "http://192.168."
| where ProcessCommandLine !contains "http://172.16."
| where ProcessCommandLine !contains "http://172.17."
| where ProcessCommandLine !contains "http://172.18."
| where ProcessCommandLine !contains "http://172.19."
| where ProcessCommandLine !contains "http://172.20."
| where ProcessCommandLine !contains "http://172.21."
| where ProcessCommandLine !contains "http://172.22."
| where ProcessCommandLine !contains "http://172.23."
| where ProcessCommandLine !contains "http://172.24."
| where ProcessCommandLine !contains "http://172.25."
| where ProcessCommandLine !contains "http://172.26."
| where ProcessCommandLine !contains "http://172.27."
| where ProcessCommandLine !contains "http://172.28."
| where ProcessCommandLine !contains "http://172.29."
| where ProcessCommandLine !contains "http://172.30."
| where ProcessCommandLine !contains "http://172.31."
| extend URL = split(ProcessCommandLine, "http://")[1]
| extend Domain = split(URL, "/")[0]
| where Domain !contains ".localhost"
| where Domain contains "." and Domain !endswith ".local"
| project Timestamp, DeviceName, FileName, ProcessCommandLine, Domain, FolderPath, FileSize, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessFolderPath
```

## TTP hunt - Only include IPs
```
DeviceProcessEvents 
| where Timestamp > ago(30d) 
| where InitiatingProcessFileName=~ "svchost.exe"
| where FileName == "rundll32.exe" and ProcessCommandLine contains "davclnt.dll" and ProcessCommandLine contains "DavSetCookie"
| where ProcessCommandLine matches regex @":\/\/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}"
| where ProcessCommandLine !contains "http://10."
| where ProcessCommandLine !contains "http://192.168."
| where ProcessCommandLine !contains "http://172.16."
| where ProcessCommandLine !contains "http://172.17."
| where ProcessCommandLine !contains "http://172.18."
| where ProcessCommandLine !contains "http://172.19."
| where ProcessCommandLine !contains "http://172.20."
| where ProcessCommandLine !contains "http://172.21."
| where ProcessCommandLine !contains "http://172.22."
| where ProcessCommandLine !contains "http://172.23."
| where ProcessCommandLine !contains "http://172.24."
| where ProcessCommandLine !contains "http://172.25."
| where ProcessCommandLine !contains "http://172.26."
| where ProcessCommandLine !contains "http://172.27."
| where ProcessCommandLine !contains "http://172.28."
| where ProcessCommandLine !contains "http://172.29."
| where ProcessCommandLine !contains "http://172.30."
| where ProcessCommandLine !contains "http://172.31."
| project Timestamp, DeviceName, FileName, ProcessCommandLine, FolderPath, FileSize, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessFolderPath
```

# CrowdStrike
## TTP hunt - Includes domains and IPs
```
event_platform IN (win) event_simpleName=ProcessRollup2
| regex CommandLine="(?i).*davclnt\.dll\,DavSetCookie.*https?:\/\/.*"
| regex CommandLine != "(.*(10\..*|192\.168\..*|127\..*|172\.1[6-9]\..*|172\.2[0-9]\..*|172\.3[0-1]\..*).*)"
| stats dc(FileName) as fnameCount, earliest(ProcessStartTime_decimal) as firstRun, latest(ProcessStartTime_decimal) as lastRun, values(FileName) as filesRun, values(CommandLine) as cmdsRun by company, cid, aid, ComputerName, ParentBaseFileName, ParentProcessId_decimal
| eval graphExplorer=case(ParentProcessId_decimal!="","https://falcon.eu-1.crowdstrike.com/graphs/process-explorer/tree?id=pid:".aid.":".ParentProcessId_decimal)
| convert ctime(firstRun), ctime(lastRun)
| table company, cid, aid, ComputerName, ParentBaseFileName, filesRun, cmdsRun, firstRun, lastRun, graphExplorer
```

## TTP hunt - Only include IPs
```
event_platform IN (win) event_simpleName=ProcessRollup2 
| regex CommandLine = "(?i).*davclnt\.dll\,DavSetCookie.*https?:\/\/.*"
| regex CommandLine = ":\/\/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}"
| regex CommandLine != "(.*(10\..*|192\.168\..*|127\..*|172\.1[6-9]\..*|172\.2[0-9]\..*|172\.3[0-1]\..*).*)"
| stats dc(FileName) as fnameCount, earliest(ProcessStartTime_decimal) as firstRun, latest(ProcessStartTime_decimal) as lastRun, values(FileName) as filesRun, values(CommandLine) as cmdsRun by company, cid, aid, ComputerName, ParentBaseFileName, ParentProcessId_decimal
| eval graphExplorer=case(ParentProcessId_decimal!="","https://falcon.eu-1.crowdstrike.com/graphs/process-explorer/tree?id=pid:".aid.":".ParentProcessId_decimal)
| convert ctime(firstRun), ctime(lastRun)
| table company, cid, aid, ComputerName, ParentBaseFileName, filesRun, cmdsRun, firstRun, lastRun, graphExplorer
```